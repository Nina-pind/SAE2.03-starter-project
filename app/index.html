<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>SAE2.03 APP</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <linkgetSelectedprofile_i
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/base.css" />
  </head>

  <body>
    <header id="header"></header>
    <section id="content"></section>

    <script type="module">
      const HOST_URL = "https://mmi.unilim.fr/~pinardel2/SAE2.03-Pinardel";
      import { NavBar } from "./component/NavBar/script.js";
      import { Films } from "./component/film/script.js";
      import { MovieTrailer } from "./component/movieTrailer/script.js";
      import { MovieCategory } from "./component/movieCategory/script.js";

      import { DataMovie } from "./data/dataMovie.js";
      import { DataProfile } from "./data/dataProfile.js";

      //import { MovieTrailer } from "./component/movieTrailer/script.js";

      // Controleur
      // Rappel, Ã©crire window.C plutÃ´t que let C est nÃ©cessaire pour tester depuis la console du navigateur
      // Une fois l'application terminÃ©e, on pourrait remettre let C.
      window.C = {};
      C.activeprofile_id = null; // ID du profil actif

      C.handlerAbout = function () {
        alert(
          "Ceci est une base de projet pour la SAE2.03 Ã©dition 2025. Bonne chance !"
        );
      };

      C.handlerHome = function () {
        C.getAllMovies(); // RÃ©-affiche la liste des films
      };

      C.handlerTrailer = async function (movie_Id) {
        // RÃ©cupÃ©rer les dÃ©tails du film depuis le serveur
        let movieTrailer = await DataMovie.requestMovieTrailer(movie_Id);

        // VÃ©rifiez si les donnÃ©es sont valides
        if (!movieTrailer || !movieTrailer.name) {
          throw new Error("Les dÃ©tails du film sont invalides ou manquants.");
        }

        // Afficher les dÃ©tails du film
        V.renderMovieTrailer(movieTrailer);
      };

      C.getAllMovies = async function () {
        const age = C.getSelectedProfileAge();
        let data = await DataMovie.requestMoviesByCategory(age);
        V.renderMoviesByCategory(data); // âœ… On les passe Ã  la vue
      };

      C.start = function () {
        V.renderNavBar(
          "C.handlerAbout()",
          "C.handlerHome()",
          "C.changeProfile(event)"
        );
        C.getAllMovies(); // Appelle la fonction pour rÃ©cupÃ©rer les films
        V.renderMovieTrailer();
      };

      C.addFavorite = async function (movie_id) {
        let profileId = C.getSelectedprofile_id();

        if (!profileId) {
          alert("Veuillez sÃ©lectionner un profil avant d'ajouter un favori.");
          return;
        }

        let response = await DataMovie.addFavorite(profileId, movie_id);
        alert(response); // Affiche un message de confirmation
        C.getAllMovies(); // Recharge la liste des films
      };

      /**
       * C.showFavorites
       * Affiche les favoris pour le profil sÃ©lectionnÃ©.
       */
      C.showFavorites = async function (profile_id) {
        profile_id = C.getSelectedprofile_id();

        if (!profile_id) {
          alert("Veuillez sÃ©lectionner un profil pour voir les favoris.");
          return;
        }

        let favorites = await DataMovie.getFavorites(profile_id);
        V.renderFavorites(favorites);
      };

      /**
       * C.removeFavorite
       * Supprime un film des favoris pour le profil sÃ©lectionnÃ©.
       */
      C.removeFavorite = async function (movie_Id) {
        const profile_id = C.getSelectedprofile_id();
        if (!profile_id || profile_id === "null") {
          alert("Veuillez sÃ©lectionner un profil pour retirer un favori.");
          return;
        }

        const response = await DataMovie.removeFavorite(profile_id, movie_Id);
        alert(response);
        C.showFavorites(); // Recharge les favoris
      };

      C.changeProfile = function (selectElement) {
        const profile_id = selectElement.value; // RÃ©cupÃ¨re l'ID du profil sÃ©lectionnÃ©
        C.activeprofile_id = profile_id; // Met Ã  jour le profil actif

        console.log("Profil sÃ©lectionnÃ© :", profile_id); // VÃ©rifier le profil sÃ©lectionnÃ©

        // Met Ã  jour l'avatar
        const avatarElement = document.getElementById("profile-image");
        if (!profile_id) {
          avatarElement.style.display = "none";
          return;
        }

        const selectedOption =
          selectElement.options[selectElement.selectedIndex];
        const avatarFileName =
          selectedOption.dataset.img || "default-avatar.jpg";
        avatarElement.src = `https://mmi.unilim.fr/~pinardel2/SAE2.03-Pinardel/server/images/${avatarFileName}`;
        avatarElement.style.display = "block";

        // Recharge les films en fonction de l'Ã¢ge du profil sÃ©lectionnÃ©
        C.getAllMovies();
      };

      C.getSelectedProfileAge = function () {
        const selectElement = document.querySelector(".navbar__select");
        if (selectElement) {
          const selectedOption =
            selectElement.options[selectElement.selectedIndex];
          return parseInt(selectedOption.dataset.age, 10) || 0; // RÃ©cupÃ¨re l'Ã¢ge ou retourne 0
        }
        return 0; // Valeur par dÃ©faut si aucun profil n'est sÃ©lectionnÃ©
      };

      C.getSelectedprofile_id = function () {
        const selectElement = document.querySelector(".navbar__select");
        if (selectElement) {
          const value = selectElement.value || null;
          console.log("getSelectedprofile_id â†’", value); // ðŸ‘ˆ Debug
          return value !== "null" ? value : null; // Ã‰vite de retourner "null" comme chaÃ®ne
        }
        return null;
      };

      // Vue (contient tout ce qui est relatif Ã  l'affichage)
      window.V = {};

      /**
       * V.renderNavBar
       *
       * Cette fonction est responsable de l'affichage de la barre de navigation (NavBar).
       * Elle sÃ©lectionne l'Ã©lÃ©ment HTML avec l'ID "header" et y insÃ¨re le contenu
       * formatÃ© par le composant NavBar.
       */
      V.renderNavBar = async function (hAbout, hHome) {
        const profiles = await DataProfile.read(); // RÃ©cupÃ¨re les profils depuis le serveur
        const header = document.querySelector("#header");
        header.innerHTML = await NavBar.format(hAbout, hHome, profiles);
      };

      V.renderMovies = function (data) {
        let content = document.querySelector("#content");
        content.innerHTML = Films.formatLi(data);
      };

      V.renderMovieTrailer = function (movieData) {
        let content = document.querySelector("#content");
        content.innerHTML = MovieTrailer.format(movieData);
      };

      V.renderMoviesByCategory = function (data, profile_id, favorites) {
        let content = document.querySelector("#content");
        content.innerHTML = data
          .map((category) =>
            MovieCategory.format(category, profile_id, favorites)
          )
          .join("");
      };

      V.renderFavorites = function (favorites) {
        const content = document.querySelector("#content");
        if (!Array.isArray(favorites) || favorites.length === 0) {
          content.innerHTML = "<p>Votre liste de favoris est vide.</p>";
          return;
        }

        content.innerHTML = favorites
          .map(
            (fav) => `
      <div class="favorite">
        <img src="https://mmi.unilim.fr/~pinardel2/SAE2.03-Pinardel/server/images/${fav.image}" alt="${fav.name}" />
        <h3>${fav.name}</h3>
        <button onclick="C.removeFavorite(${fav.id})">Retirer</button>
      </div>`
          )
          .join("");
      };

      C.start(); // DÃ©marre l'application
    </script>
  </body>
</html>
<script type="module"></script>
